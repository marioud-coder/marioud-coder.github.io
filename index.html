<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Chouchous Marioud</title>

    <link rel="icon"
          type="image/png"
          href="static/images/favicon.png">

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&display=swap" rel="stylesheet">

    <style>

        body {
            font-family: 'Playfair Display', serif;
        }

        .chouchou-container img {
            width: 100%;
        }

        .chouchou-title {
            text-align: center;
            margin-top: 8px;
        }

        .text-center {
            text-align: center;
        }

        .gallery {
            display: grid;
            padding: 0 30px;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            grid-column-gap: 25px;
            grid-row-gap: 45px;
            margin-bottom: 70px;
        }

        #couverture {
            margin: 20px auto 50px;
            width: 700px;
            max-width: 100%;
            display: inline-block;
        }

        #app {
            transition: opacity 2.5s;
        }

        .hidden {
            opacity: 0;
        }

        #passer-commande-container {
            margin-bottom: 50px;
        }

        .marioud-btn {
            font-size: 18px;
            outline: 0;
            padding: 10px 28px;
            color: #b70000;
            border-radius: 4px;
            background-color: white;
            border: 1px solid #b70000;
            cursor: pointer;
            text-decoration: none;
        }

        .marioud-btn:hover {
            background-color: #e39e9e44;
        }


        .marioud-select {
            width: 50px;
            height: 20px;
            outline: 0;
            background-color: white;
        }

        .btn-ajouter-panier {
            color: #b70000;
            outline: 0;
            padding: 4px;
            border-radius: 4px;
            background-color: white;
            border: 1px solid #b70000;
            cursor: pointer;
            text-decoration: none;
        }

        .not-available {
            margin-top:5px;
            color: #b70000;
        }

    </style>
</head>
<body>

<div id="app" class="hidden">

    <div v-if="loaded">

        <div class="text-center">
            <img id="couverture" src="static/images/couverture.png" alt="">
        </div>

        <div id="passer-commande-container" class="text-center">
            <a class="marioud-btn"
               target="_blank"
               @click="validateCommand"
            >
                Passer commande !
            </a>
        </div>

        <div
                class="gallery">
            <div
                    v-for="chouchou in chouchous"
                    class="chouchou-container">
                <img :src="chouchou.imageUrl" alt="">
                <div class="chouchou-title">
                    {{chouchou.title}} <br>
                    {{chouchou.price}}.-
                    <div style="margin-top:0.5em;" v-if="chouchou.stock > 0">
                        <select
                                v-model="chouchou.nbWanted"
                                class="marioud-select">
                            <option>0</option>
                            <option v-for="(n, index) in chouchou.stock" :key="index">{{n}}</option>
                        </select>
                        <button v-if="chouchou.nbWanted"
                                @click="addToPanier(chouchou)"
                                class="btn-ajouter-panier">
                            Dans mon panier !
                        </button>
                    </div>
                    <div v-else class="not-available">
                        Plus dispo !
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="static/vue.min.js"></script>

<script type="application/javascript">

    var app = new Vue({
        el: '#app',
        data: {
            chouchous: [],
            loaded: false,
            panier: [],
        },
        methods: {
            addToPanier: function(chouchou) {
                if (this.panier.indexOf(chouchou) === -1) {
                    this.panier.push(chouchou);
                }
            },
            validateCommand: function() {
                var url = "https://vl8i0fdnvk.execute-api.us-east-1.amazonaws.com/globalStage";
                var r = new XMLHttpRequest();
                r.open("POST", url, true);
                r.onreadystatechange = function () {
                    if (r.readyState != 4 || r.status != 200) {
                        console.error('ERROR', r);
                        return;
                    }
                    var resp = r.responseText;
                    console.log('RESP', resp);
                };
                r.send('data=yoyo');
            }
        },
        computed: {
            panierReal: function() {
                return this.panier.filter(function(p) {
                    return p.nbWanted > 0;
                });
            }
        }
    });

    console.log(app.message);

    var showPage = function() {
        document.getElementById('app').classList.remove('hidden');
    }

    var r = new XMLHttpRequest();
    r.open("GET", "data.csv?buster=" + Date.now(), true);
    r.onreadystatechange = function () {
        if (r.readyState != 4 || r.status != 200) {
            showPage();
            return;
        }
        var resp = r.responseText;
        var rows = resp.split('\n');
        var jsData = rows.slice(1).map(function(row) {
            var rowData = row.split(',');
            return {
                nbWanted: 0,
                title: rowData[0],
                price: rowData[1],
                imageUrl: 'static/images/chouchous/' + rowData[2],
                stock: parseInt(rowData[3]) || 0
            };
        });
        console.log(rows);
        console.log(jsData);

        app.chouchous = jsData;
        app.loaded = true;
        showPage();
    };
    r.send();

</script>

</body>
</html>